button[onclick="mobileRegister()"] 手机号注册
button[onclick="wechatRegister()"] 微信扫码注册
button[onclick="emailRegister()"] 邮箱注册


div[id="bind-mobile" style="display: none"]
  h4[id="mobile-text"] 手机号注册
  = simple_form_for(@user, url: sign_up_path, remote: true, method: :post, html: {class: "margin-bottom-0 register"}) do |f|
    - if flash[:alert]
      .alert.alert-danger
        = flash[:alert]
    .form-group.m-b-25.m-t-10
      label 手机号
      input.form-control.input-lg[placeholder="手机号"name="user[mobile]"type="text"]
      input.[type="hidden" name="user[wechat_code]" id="wechat-response-code"]
    .form-group.m-b-25.p-0.row
      .col-xs-9
        label 验证码
        input.form-control.input-lg[name="user[code]"type="text"placeholder="验证码"]
      .col-xs-3.text-right
        button.btn.btn-default.input-lg.get_code[data-url=api_v1_sessions_sms_path] 获取验证码
    .text-center.text-danger.title_error
    .login-buttons
      = f.submit '注册', class: 'btn btn-success btn-block btn-lg', id: 'click_login', data:{href: root_path}

div[id="bind-wechat" style="display: none"]
  h4 绑定微信

  img id="qrcode-auth-image" width="180" style="margin-left: 50%; transform: translateX(-50%)"
  p align="center" id="qrcode-auth-message"

div[id="bind-email" style="display: none"]
  h4 邮箱注册
  = simple_form_for(@user, url: sign_up_path, remote: true, method: :post, html: {class: "margin-bottom-0 register"}) do |f|
    - if flash[:alert]
      .alert.alert-danger
        = flash[:alert]
    .form-group.m-b-25.m-t-10
      label 邮箱
      input.form-control.input-lg[placeholder="邮箱"name="user[email]"type="text"]
    .form-group.m-b-25.p-0.row
      label 密码
      input.form-control.input-lg[name="user[password]"type="password"placeholder="密码"]
    .form-group.m-b-25.p-0.row
      label 确认密码
      input.form-control.input-lg[name="user[password_confirmation]"type="password"placeholder="确认密码"]
    .text-center.text-danger.title_error
    .login-buttons
      = f.submit '注册', class: 'btn btn-success btn-block btn-lg', id: 'click_login', data:{href: root_path}
  
  
javascript:
  function mobileRegister () {
    $('#bind-wechat').css('display', 'none')
    $('#bind-mobile').css('display', 'block')
    $('#bind-email').css('display', 'none')
  }
  function wechatRegister () {
    $('#bind-wechat').css('display', 'block')
    $('#bind-mobile').css('display', 'none')
    $('#bind-email').css('display', 'none')
  }
  function emailRegister () {
    $('#bind-email').css('display', 'block')
    $('#bind-mobile').css('display', 'none') 
    $('#bind-wechat').css('display', 'none')   
  }

  var QrcodeAuth = function (){
    var instance = this;
    this.init = function() {
      $.getJSON('http://wxopen.tanmer.com/wx/mp_auth/qrcode/wx4c40bb18df07aafc.json', function(data){
        $('img#qrcode-auth-image').attr('src', data.svg)
        instance.ping(data)
      })
    }

    this.ping = function(response) {
      $.getJSON(response.status_url, function(data){
        console.log(data)
        switch(data.status){
          case 'confirmed':
            $('#qrcode-auth-message').text('已确认登录，正在获取用户信息...')
            //instance.fetchUid(response.code)
            $("#wechat-response-code").val(response.code)
            $('#bind-wechat').css('display', 'none')
            $('#bind-mobile').css('display', 'block')
            $('#mobile-text').text('微信绑定手机号')
            break;
          case 'waiting':
            $('#qrcode-auth-message').text('正在等待扫码...')
            setTimeout(instance.ping, 5000, response)
            break;
          case 'confirming':
            $('#qrcode-auth-message').text('等待微信端确认...')
            setTimeout(instance.ping, 5000, response)
            break;
          case 'expired':
            $('#qrcode-auth-message').text('二维码过期，正在刷新二维码...')
            instance.init()
            break;
        }
      })
    }

    this.fetchUid = function(code) {
      var url = 'http://wxopen.tanmer.com/wx/mp_auth/wx4c40bb18df07aafc/fetch_uid/--code--';
      $.getJSON(url.replace('--code--', code), function(data){
        $('#qrcode-auth-message').text('uid是' + data.uid)
      })
    }
  }
  $(function(){
    (new QrcodeAuth()).init()
  })
