<%= render file: @cms_site.template_dir + '_header.html' %>
<div id="wrap">
  <section id="start" class="padding-top-bottom text-center">
    <div class="container">
      <div class="row header">
        <div class="col-md-12">
          <h2>订单创建成功</h2>
          <p>订单ID:<%= @order.id %></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-8 col-md-offset-2">
          <!-- pay start -->
          <div class="hd">
              <h1 class="page_title"><%= PaymentCore.title %></h1>
              <p class="page_desc"><%= PaymentCore.description %></p>
          </div>

          <div class="bd">
              <div class="weui_cells">
                  <div class="weui_cell">
                      <div class="weui_cell_bd weui_cell_primary">
                          <p>订单编号</p>
                      </div>
                      <div class="weui_cell_ft"><%= @order.code %></div>
                  </div>
                  <div class="weui_cell">
                      <div class="weui_cell_bd weui_cell_primary">
                          <p>支付金额</p>
                      </div>
                      <div class="weui_cell_ft"><%= @order.order_products.first.price.to_f %>元</div>
                  </div>
              </div>
              <div class="weui_btn_area">
                  <a class="btn btn-primary weui_btn weui_btn_primary" href="javascript:" id="pay">支 付</a>
              </div>
          </div>

          <%= javascript_include_tag 'https://one.pingxx.com/lib/pingpp_one.js' %>
          <script>
          document.addEventListener('pingpp_one_ready',function(){
                  document.getElementById('pay').addEventListener('click',function(){
                      pingpp_one.init({
                          app_id: '<%= @app_id || 1%>',                     //该应用在 ping++ 的应用 ID
                          order_no:'<%= @order_no || "sd2" %>',                     //订单在商户系统中的订单号
                          amount: <%= @amount || 2 %>,                                   //订单价格，单位：人民币 分
                          // 壹收款页面上需要展示的渠道，数组，数组顺序即页面展示出的渠道的顺序
                          // upmp_wap 渠道在微信内部无法使用，若用户未安装银联手机支付控件，则无法调起支付
                          channel: ['alipay_wap', 'wx_pub','upacp_wap','yeepay_wap','jdpay_wap','bfb_wap'],
                          // channel: <%= @channels.to_s.html_safe %>,
                          charge_url: '<%= 'http://www.lvh.me:5000/frontend/orders/6' %>',  //商户服务端创建订单的 url
                          charge_param: <%= @charge_param.to_json.html_safe %>,                      //(可选，用户自定义参数，若存在自定义参数则壹收款会通过 POST 方法透传给 charge_url)
                          open_id: '<%= @open_id %>',                      //(可选，使用微信公众号支付时必须传入)
                          debug: <%= @debug || 0 %>                                   //(可选，debug 模式下会将 charge_url 的返回结果透传回来)
                      },function(res){
                          //debug 模式下获取 charge_url 的返回结果
                          if(res.debug&&res.chargeUrlOutput){
                              console.log(res.chargeUrlOutput);
                          }
                          if(!res.status){
                              //处理错误
                              if(res.chargeUrlOutput){
                                c_res= JSON.parse(res.chargeUrlOutput);
                                alert(c_res.error || (res.debug ? JSON.stringify(res) : res.msg));
                              }else{
                                alert(res.debug ? JSON.stringify(res) : res.msg);
                              }
                          }
                          else{
                              //debug 模式下调用 charge_url 后会暂停，可以调用 pingpp_one.resume 方法继续执行
                              if(res.debug&&!res.wxSuccess){
                                  if(confirm('当前为 debug 模式，是否继续支付？')){
                                      pingpp_one.resume();
                                  }
                              }
                              //若微信公众号渠道需要使用壹收款的支付成功页面，则在这里进行成功回调，
                              //调用 pingpp_one.success 方法，你也可以自己定义回调函数
                              //其他渠道的处理方法请见第 2 节
                              else pingpp_one.success(function(res){
                                  if(!res.status){
                                      alert(res.debug ? JSON.stringify(res) : res.msg);
                                  }
                              },function(){
                                  //这里处理支付成功页面点击“继续购物”按钮触发的方法，
                                  //例如：若你需要点击“继续购物”按钮跳转到你的购买页，
                                  //则在该方法内写入 window.location.href = "你的购买页面 url"
                                  window.location.href='<%= @success_url %>';//示例
                              });
                          }
                      });
                  });
              });
          </script>

        <!-- pay end -->
        </div>
      </div>
    </div>
  </section>
  <!-- vertical center / slider -->
  <!-- end vertical center / slider -->
  <%= render file: @cms_site.template_dir + '_footer.html' %>
</div>
